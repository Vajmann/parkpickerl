<!-- Version 4.1 ‚Äì Wien-Rot & Wei√ü Theme ‚Äì Onboarding, Glassmorphism, Haptic, Swipe, Auto-Check, Light Mode, OG-Tags -->
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#007AFF">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Parkpickerl">
<meta name="description" content="Pr√ºfe sofort ob dein Wiener Parkpickerl an diesem Ort gilt ‚Äì kostenlos, offline-f√§hig.">
<meta name="robots" content="index, follow">
<meta property="og:title" content="Parkpickerl Checker Wien">
<meta property="og:description" content="Pr√ºfe ob dein Parkpickerl hier gilt ‚Äì schnell, gratis, offline-f√§hig.">
<meta property="og:type" content="website">
<meta property="og:locale" content="de_AT">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Parkpickerl Checker ‚Äì Wien</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#F2F2F7;--surface:#1a1a1a;--surface2:#242424;--border:#2e2e2e;
  --text:#f5f5f5;--muted:#888;
  --accent:#007AFF;--accent2:#ff1f35;--accent-glow:rgba(226,0,26,.4);
  --green:#3ddc84;--red:#ff5f5f;--blue:#4a9eff;
  --font-d:-apple-system,'SF Pro Display',sans-serif;--font-m:'DM Mono',monospace;
  --safe-top:env(safe-area-inset-top,0px);--safe-bot:env(safe-area-inset-bottom,0px);
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--font-d);overflow:hidden;-webkit-tap-highlight-color:transparent}
#app{display:flex;flex-direction:column;height:100vh;height:100dvh;padding-top:var(--safe-top)}

/* Header */
header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:rgba(22,24,31,.9);border-bottom:1px solid rgba(226,0,26,.2);gap:10px;flex-shrink:0;box-shadow:0 2px 20px rgba(226,0,26,.1)}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:38px;height:38px;background:#f0c844;border-radius:10px;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 16px rgba(226,0,26,.5),inset 0 1px 0 rgba(255,255,255,.15);flex-shrink:0}
.logo-icon svg{width:22px;height:22px;fill:#000}
.logo-text h1{font-size:17px;font-weight:800;letter-spacing:-.5px;color:#fff}
.logo-text span{font-size:10px;color:rgba(226,0,26,.9);font-family:var(--font-m);letter-spacing:.5px;text-transform:uppercase}
#bezirkBtn{display:flex;align-items:center;gap:8px;background:rgba(226,0,26,.08);border:1.5px solid rgba(226,0,26,.25);color:var(--text);padding:8px 14px;border-radius:50px;font-family:var(--font-d);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap}
#bezirkBtn:hover{border-color:var(--accent);background:rgba(226,0,26,.15)}
#bezirkBtn.selected{border-color:rgba(226,0,26,.6);background:rgba(226,0,26,.12)}
.bez-dot{width:8px;height:8px;border-radius:50%;background:var(--muted);flex-shrink:0;transition:background .3s}
#bezirkBtn.selected .bez-dot{background:var(--accent);box-shadow:0 0 6px var(--accent)}

/* Content & Map */
.content{flex:1;position:relative;overflow:hidden}
#map{width:100%;height:100%}

/* Floating Result Card */
#resultCard{
  position:absolute;top:16px;left:16px;right:16px;
  background:rgba(22,24,31,.9);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px 16px;
  display:flex;align-items:center;gap:12px;z-index:400;
  transform:translateY(-100px);opacity:0;pointer-events:none;
  transition:transform .4s cubic-bezier(.34,1.56,.64,1),opacity .3s;
  box-shadow:0 8px 32px rgba(0,0,0,.5)
}
#resultCard.visible{transform:translateY(0);opacity:1;pointer-events:auto}
#resultCard.inside{border-color:rgba(61,220,132,.4);box-shadow:0 8px 32px rgba(61,220,132,.15)}
#resultCard.outside{border-color:rgba(255,95,95,.4);box-shadow:0 8px 32px rgba(255,95,95,.15)}
#resultCard.checking{border-color:rgba(240,200,68,.4)}
.result-icon{font-size:32px;flex-shrink:0}
.result-body{flex:1;min-width:0}
.result-title{font-size:15px;font-weight:800;letter-spacing:-.3px}
.result-sub{font-size:11px;color:var(--muted);font-family:var(--font-m);margin-top:2px;line-height:1.4}
.result-close{background:rgba(255,255,255,.08);border:none;color:var(--muted);width:26px;height:26px;border-radius:50%;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}

/* GPS FAB */
#gpsFab{position:absolute;bottom:calc(28px + var(--safe-bot));left:50%;transform:translateX(-50%);background:linear-gradient(145deg,var(--accent2),var(--accent));color:#fff;border:none;width:66px;height:66px;border-radius:50%;font-size:26px;cursor:pointer;z-index:400;box-shadow:0 4px 24px var(--accent-glow),0 2px 8px rgba(0,0,0,.4);transition:transform .2s,box-shadow .2s;display:flex;align-items:center;justify-content:center}
#gpsFab:active{transform:translateX(-50%) scale(.92)}
#gpsFab.loading{animation:fabpulse 1s infinite}
@keyframes fabpulse{0%,100%{box-shadow:0 4px 24px var(--accent-glow)}50%{box-shadow:0 4px 48px rgba(226,0,26,.8),0 0 0 8px rgba(226,0,26,.1)}}

/* Details FAB */
#detailsFab{
  position:absolute;bottom:calc(28px + var(--safe-bot));right:16px;
  width:48px;height:48px;background:var(--surface);border:1px solid var(--border);
  border-radius:50%;font-size:20px;cursor:pointer;z-index:400;
  box-shadow:0 4px 16px rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;
  transition:transform .15s
}
#detailsFab:active{transform:scale(.92)}

/* Map offline overlay */
#mapOffline{position:absolute;inset:0;background:rgba(14,15,19,.85);display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px;z-index:300;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
#mapOffline.visible{display:flex}
#mapOffline span{font-size:42px}
#mapOffline p{font-size:14px;color:var(--muted);font-family:var(--font-m);text-align:center}

/* Onboarding */
#onboarding{position:fixed;inset:0;z-index:2000;background:linear-gradient(160deg,#150002 0%,#0f0f0f 60%);display:flex;flex-direction:column;padding:calc(var(--safe-top) + 40px) 24px calc(var(--safe-bot) + 24px);transition:opacity .4s,transform .4s}
#onboarding.hidden{opacity:0;transform:scale(.96);pointer-events:none}
.ob-logo{width:80px;height:80px;background:linear-gradient(145deg,#ff1f35,#007AFF,#a80012);border-radius:22px;display:flex;align-items:center;justify-content:center;margin-bottom:28px;box-shadow:0 12px 40px rgba(226,0,26,.55),inset 0 1px 0 rgba(255,255,255,.2)}
.ob-logo-p{font-size:42px;font-weight:900;color:#fff;font-family:var(--font-d);line-height:1;letter-spacing:-2px;text-shadow:0 2px 8px rgba(0,0,0,.3)}
.ob-title{font-size:30px;font-weight:800;letter-spacing:-1px;margin-bottom:8px;line-height:1.2;color:#fff}
.ob-title span{color:var(--accent)}
.ob-sub{font-size:14px;color:var(--muted);font-family:var(--font-m);line-height:1.6;margin-bottom:28px}
.ob-label{font-size:11px;text-transform:uppercase;letter-spacing:1.5px;color:rgba(226,0,26,.8);font-family:var(--font-m);margin-bottom:12px}
.bezirk-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;overflow-y:auto;flex:1;padding-bottom:4px}
.bezirk-grid::-webkit-scrollbar{display:none}
.bez-option{background:rgba(255,255,255,.04);border:1.5px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 6px;text-align:center;cursor:pointer;transition:all .15s;font-size:11px;font-weight:600;line-height:1.3;font-family:var(--font-d);color:var(--text)}
.bez-option:active{transform:scale(.95)}
.bez-option.selected{border-color:var(--accent);background:rgba(226,0,26,.18);color:#ff8090}
.bez-nr{font-size:18px;font-weight:800;display:block;margin-bottom:2px}
.ob-continue{margin-top:16px;background:linear-gradient(135deg,#ff1f35,#007AFF);color:#fff;border:none;border-radius:14px;padding:16px;font-family:var(--font-d);font-weight:800;font-size:16px;cursor:pointer;width:100%;flex-shrink:0;opacity:.4;pointer-events:none;transition:opacity .2s;box-shadow:0 4px 20px rgba(226,0,26,.4)}
.ob-continue.active{opacity:1;pointer-events:auto}

/* Bottom Sheets */
.sheet-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:900;opacity:0;pointer-events:none;transition:opacity .3s}
.sheet-overlay.visible{opacity:1;pointer-events:auto}
.bottom-sheet{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);border-radius:24px 24px 0 0;padding:0 20px calc(20px + var(--safe-bot));transform:translateY(100%);transition:transform .35s cubic-bezier(.4,0,.2,1);z-index:1000;max-height:82vh;overflow-y:auto}
.bottom-sheet.open{transform:translateY(0)}
.sheet-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:14px auto 18px}
.sheet-title{font-size:18px;font-weight:800;margin-bottom:20px}
.info-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);font-size:13px}
.info-row:last-child{border-bottom:none}
.info-row .key{color:var(--muted);font-family:var(--font-m)}
.info-row .val{font-weight:600;font-size:12px;font-family:var(--font-m);color:var(--blue)}
.sheet-btn{border:none;border-radius:10px;padding:11px 16px;font-family:var(--font-d);font-weight:700;font-size:13px;cursor:pointer}
.sheet-btn:active{opacity:.7}

/* Toast */
.toast{position:fixed;bottom:calc(110px + var(--safe-bot));left:50%;transform:translateX(-50%) translateY(20px);background:rgba(22,24,31,.95);border:1px solid var(--border);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-radius:50px;padding:10px 20px;font-size:13px;font-family:var(--font-m);opacity:0;transition:transform .3s,opacity .3s;z-index:3000;white-space:nowrap;max-width:90vw;overflow:hidden;text-overflow:ellipsis;pointer-events:none}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.toast.success{border-color:var(--green);color:var(--green)}
.toast.error{border-color:var(--red);color:var(--red)}
.toast.info{border-color:var(--accent);color:#ff8090}

/* Banners */
#offlineBanner{display:none;background:rgba(255,95,95,.1);border-bottom:1px solid rgba(255,95,95,.3);padding:8px 16px;text-align:center;font-size:12px;color:var(--red);font-family:var(--font-m);flex-shrink:0}
#offlineBanner.visible{display:block}
#installBanner{display:none;background:rgba(226,0,26,.06);border-bottom:1px solid rgba(226,0,26,.2);padding:10px 16px;align-items:center;gap:10px;flex-shrink:0}
#installBanner.visible{display:flex}
#installBanner p{flex:1;font-size:12px;font-family:var(--font-m)}
#installBanner strong{color:var(--accent)}
.btn-install{background:linear-gradient(135deg,#ff1f35,#007AFF);color:#fff;border:none;border-radius:8px;padding:7px 14px;font-weight:700;font-size:12px;cursor:pointer;font-family:var(--font-d)}
.btn-dismiss{background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer}

/* Light Mode */
@media(prefers-color-scheme:light){
  :root{--bg:#f5f5f7;--surface:#fff;--surface2:#f0f0f2;--border:#e0e0e5;--text:#1a1a2e;--muted:#8888aa}
  #resultCard{background:rgba(255,255,255,.92)}
  #onboarding{background:#f5f5f7}
}
</style>
</head>
<body>
<div id="app">

<!-- Onboarding -->
<div id="onboarding">
  <div class="ob-logo">
    <span class="ob-logo-p">P</span>
  </div>
  <div class="ob-title">Park<span>pickerl</span><br>Checker Wien</div>
  <div class="ob-sub">W√§hle deinen Heimatbezirk.<br>Die App merkt ihn sich dauerhaft.</div>
  <div class="ob-label">Mein Bezirk</div>
  <div class="bezirk-grid" id="bezirkGrid"></div>
  <button class="ob-continue" id="obContinue" onclick="finishOnboarding()">Los geht's ‚Üí</button>
</div>

<!-- Banners -->
<div id="offlineBanner">üìµ Offline ‚Äì Kartencache aktiv</div>
<div id="installBanner">
  <p>üì± <strong>App installieren</strong> ‚Äì Homescreen & offline</p>
  <button class="btn-install" id="installBtn">Installieren</button>
  <button class="btn-dismiss" id="dismissBtn">‚úï</button>
</div>

<!-- Header -->
<header>
  <div class="logo">
    <div class="logo-icon">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6 3h7a6 6 0 0 1 0 12H9v6H6V3zm3 3v6h4a3 3 0 0 0 0-6H9z"/></svg>
    </div>
    <div class="logo-text">
      <h1 style="font-size:28px;font-weight:700;">Parkpickerl</h1>
      <span>Wien ¬∑ Kurzparkzonen</span>
    </div>
  </div>
  <button id="bezirkBtn" onclick="openBezirkSheet()">
    <span class="bez-dot"></span>
    <span id="bezirkLabel">Bezirk w√§hlen</span>
    <span style="color:var(--muted);font-size:11px">‚ñæ</span>
  </button>
</header>

<!-- Karte -->
<div class="content">
  <div id="map"></div>
  <div id="mapOffline"><span>üó∫Ô∏è</span><p>Karte nicht verf√ºgbar<br>Kein Internet</p></div>

  <!-- Floating Result -->
  <div id="resultCard">
    <span class="result-icon" id="resultIcon">üÖøÔ∏è</span>
    <div class="result-body">
      <div class="result-title" id="resultTitle">Bereit</div>
      <div class="result-sub" id="resultSub">Bezirk w√§hlen &amp; GPS-Button tippen</div>
    </div>
    <button class="result-close" onclick="hideResult()">‚úï</button>
  </div>

  <!-- FABs -->
  <button id="gpsFab" onclick="getLocation()">üìç</button>
  <button id="detailsFab" onclick="openSheet('detailsSheet')">‚öôÔ∏è</button>
</div>

<!-- Sheet Overlay -->
<div class="sheet-overlay" id="sheetOverlay" onclick="closeSheet()"></div>

<!-- Bezirk Sheet -->
<div class="bottom-sheet" id="bezirkSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">Bezirk wechseln</div>
  <div class="bezirk-grid" id="bezirkGridSheet" style="max-height:60vh;overflow-y:auto;padding-bottom:16px"></div>
</div>

<!-- Details Sheet -->
<div class="bottom-sheet" id="detailsSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">Mein Pickerl</div>
  <div class="info-row"><span class="key">Breitengrad</span><span class="val" id="latVal">‚Äî</span></div>
  <div class="info-row"><span class="key">L√§ngengrad</span><span class="val" id="lonVal">‚Äî</span></div>
  <div class="info-row"><span class="key">Genauigkeit</span><span class="val" id="accVal">‚Äî</span></div>
  <div class="info-row"><span class="key">Letzter Check</span><span class="val" id="lastCheckVal">‚Äî</span></div>
  <div class="info-row"><span class="key">API-Status</span><span class="val" id="apiStatusVal">‚Äî</span></div>
  <div class="info-row"><span class="key">Mein Bezirk</span><span class="val" id="savedBezirkVal">‚Äî</span></div>
  <div class="info-row"><span class="key">Benachrichtigungen</span><span class="val" id="notifStatusVal">‚Äî</span></div>
  <div class="info-row" style="gap:10px;flex-wrap:wrap;padding-top:4px">
    <button class="sheet-btn" onclick="requestNotifications()" style="background:linear-gradient(135deg,#ff1f35,#007AFF);color:#fff;flex:1">üîî Benachrichtigungen</button>
    <button class="sheet-btn" onclick="clearSavedPos()" style="background:var(--surface2);color:var(--red);border:1px solid var(--border);flex:1">üóë Cache l√∂schen</button>
  </div>
  <div style="padding:16px 0 4px;font-size:10px;color:var(--muted);font-family:var(--font-m)">Version 4.1 ‚Äì Wien-Rot & Wei√ü Theme ¬∑ OGD Wien ¬∑ data.wien.gv.at</div>
</div>

<div class="toast" id="toast"></div>
</div>

<script>
const STORAGE = {BEZIRK:'pp_bezirk',POS:'pp_lastpos',ONBOARDED:'pp_onboarded'};
const BEZIRKE = [
  [1,'Innere Stadt'],[2,'Leopoldstadt'],[3,'Landstra√üe'],[4,'Wieden'],
  [5,'Margareten'],[6,'Mariahilf'],[7,'Neubau'],[8,'Josefstadt'],
  [9,'Alsergrund'],[10,'Favoriten'],[11,'Simmering'],[12,'Meidling'],
  [13,'Hietzing'],[14,'Penzing'],[15,'Rudolfsheim-F√ºnfhaus'],[16,'Ottakring'],
  [17,'Hernals'],[18,'W√§hring'],[19,'D√∂bling'],[20,'Brigittenau'],
  [21,'Floridsdorf'],[22,'Donaustadt'],[23,'Liesing']
];
const PROXIES=[
  u=>`https://corsproxy.io/?url=${encodeURIComponent(u)}`,
  u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  u=>`https://thingproxy.freeboard.io/fetch/${u}`
];
const WFS='https://data.wien.gv.at/daten/geo?service=WFS&request=GetFeature&version=1.1.0&outputFormat=application/json&srsName=EPSG:4326';

let map,userMarker,highlightLayer,zoneLayer;
let selectedBezirk=null,activeSheet=null,swipeStartY=0;

// ‚îÄ‚îÄ Onboarding ‚îÄ‚îÄ
function buildGrid(id,onSelect){
  const g=document.getElementById(id); g.innerHTML='';
  BEZIRKE.forEach(([nr,name])=>{
    const b=document.createElement('button');
    b.className='bez-option'; b.dataset.nr=nr;
    b.innerHTML=`<span class="bez-nr">${nr}</span>${name}`;
    b.onclick=()=>onSelect(nr,b,g);
    g.appendChild(b);
  });
}

function initOnboarding(){
  buildGrid('bezirkGrid',(nr,btn,g)=>{
    g.querySelectorAll('.bez-option').forEach(b=>b.classList.remove('selected'));
    btn.classList.add('selected');
    const oc=document.getElementById('obContinue');
    oc.classList.add('active'); oc.dataset.bez=nr;
  });
  buildGrid('bezirkGridSheet',(nr,btn,g)=>{
    g.querySelectorAll('.bez-option').forEach(b=>b.classList.remove('selected'));
    btn.classList.add('selected');
    selectBezirk(nr); setTimeout(closeSheet,300);
  });
  const onboarded=localStorage.getItem(STORAGE.ONBOARDED);
  const saved=localStorage.getItem(STORAGE.BEZIRK);
  if(onboarded&&saved){
    document.getElementById('onboarding').classList.add('hidden');
    selectBezirk(parseInt(saved),false);
    // Letzten Standort auf Karte zeigen (nur anzeigen, nicht automatisch pr√ºfen)
    const pos=localStorage.getItem(STORAGE.POS);
    if(pos){try{const{lat,lng}=JSON.parse(pos);placeMarker(lat,lng,null);map.setView([lat,lng],15);}catch(e){}}
  }
}

function finishOnboarding(){
  const bez=parseInt(document.getElementById('obContinue').dataset.bez);
  if(!bez)return;
  localStorage.setItem(STORAGE.ONBOARDED,'1');
  selectBezirk(bez);
  document.getElementById('onboarding').classList.add('hidden');
  showToast('Gespeichert! Jetzt GPS-Button tippen üìç','success');
}

// ‚îÄ‚îÄ Bezirk ‚îÄ‚îÄ
function selectBezirk(nr,hl=true){
  selectedBezirk=nr;
  try{localStorage.setItem(STORAGE.BEZIRK,nr);}catch(e){}
  const name=BEZIRKE.find(b=>b[0]===parseInt(nr))?.[1]||'';
  document.getElementById('bezirkLabel').textContent=`${nr}. ${name}`;
  document.getElementById('bezirkBtn').classList.add('selected');
  document.getElementById('savedBezirkVal').textContent=`${nr}. Bezirk`;
  document.querySelectorAll('#bezirkGridSheet .bez-option').forEach(b=>b.classList.toggle('selected',parseInt(b.dataset.nr)===parseInt(nr)));
  if(hl)highlightBezirk(nr);
  if(watchId !== null && lastLat !== null){
    // Tracking l√§uft bereits ‚Üí sofort mit aktuellem GPS-Standort neu pr√ºfen
    checkPoint(lastLat, lastLng);
  } else {
    // Tracking noch nicht aktiv ‚Üí starten
    setTimeout(startTracking, 500);
  }
}

function openBezirkSheet(){openSheet('bezirkSheet');}

// ‚îÄ‚îÄ Karte ‚îÄ‚îÄ
// Bezirksgrenzen werden beim Start von OGD Wien geladen (echte Grenzen)
let BEZIRKE_GEO = null;

function initMap(){
  map=L.map('map',{center:[48.2082,16.3738],zoom:12,zoomControl:false});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{attribution:'¬© OpenStreetMap, ¬© CARTO',subdomains:'abcd',maxZoom:19}).addTo(map);
  L.control.zoom({position:'bottomleft'}).addTo(map);
  map.on('tileerror',()=>{if(!navigator.onLine)document.getElementById('mapOffline').classList.add('visible');});
  loadRealBezirksgrenzen();
}

async function loadRealBezirksgrenzen(){
  // Versuche echte Grenzen von OGD Wien direkt (funktioniert wenn CORS erlaubt)
  // und √ºber mehrere Proxies als Fallback
  const ogdUrl='https://data.wien.gv.at/daten/geo?service=WFS&request=GetFeature&version=1.1.0&outputFormat=application/json&srsName=EPSG:4326&typeName=ogdwien:BEZIRKSGRENZEOGD';
  // Auch direkt versuchen (manchmal erlaubt OGD Wien CORS)
  const allUrls = [
    ogdUrl,
    ...PROXIES.map(p=>p(ogdUrl))
  ];
  for(const url of allUrls){
    try{
      const ctrl=new AbortController();
      const t=setTimeout(()=>ctrl.abort(),10000);
      const res=await fetch(url,{signal:ctrl.signal});
      clearTimeout(t);
      if(!res.ok)throw 0;
      const data=await res.json();
      if(!data.features||!data.features.length)throw 0;
      BEZIRKE_GEO=data;
      // Property-Namen normalisieren (BEZNR, BEZ, BEZIRK, etc.)
      BEZIRKE_GEO.features.forEach(f=>{
        const p=f.properties;
        if(!p.BEZNR) p.BEZNR = p.BEZ ?? p.BEZIRK ?? p.beznr ?? p.bez ?? p.OBJECTID;
      });
      console.log('[Bezirke] Geladen:', data.features.length, 'features');
      console.log('[Bezirke] Props:', Object.keys(data.features[0].properties));
      if(selectedBezirk)highlightBezirk(selectedBezirk);
      return;
    }catch(e){console.warn('[Bezirke] Fehlgeschlagen:', url.substring(0,60));}
  }
  showToast('Bezirksgrenzen konnten nicht geladen werden ‚ö†Ô∏è','error');
}

function highlightBezirk(bez){
  if(highlightLayer){map.removeLayer(highlightLayer);highlightLayer=null;}
  if(zoneLayer){map.removeLayer(zoneLayer);zoneLayer=null;}
  if(!BEZIRKE_GEO){
    showToast('Bezirksgrenzen laden‚Ä¶','info');
    return;
  }
  // Debug: zeige welche Properties vorhanden sind
  const sampleProps = BEZIRKE_GEO.features[0]?.properties;
  console.log('[Highlight] Suche Bezirk:', bez, '| Props:', sampleProps);
  const f=BEZIRKE_GEO.features.find(f=>parseInt(f.properties.BEZNR)===parseInt(bez));
  if(!f){
    showToast(`Bezirk ${bez} nicht gefunden in Daten ‚ö†Ô∏è`,'error');
    console.warn('[Highlight] Bezirk nicht gefunden. Verf√ºgbare BEZNR:', BEZIRKE_GEO.features.map(f=>f.properties.BEZNR));
    return;
  }
  highlightLayer=L.geoJSON(f,{style:{color:'#f0c844',weight:2.5,fillColor:'#f0c844',fillOpacity:.1,opacity:.85}}).addTo(map);
  map.fitBounds(highlightLayer.getBounds(),{padding:[60,60],maxZoom:13,animate:true});
  loadZones(bez,f);
}

async function loadZones(bez,bezF){
  const b=L.geoJSON(bezF).getBounds();
  const bbox=`${b.getWest()},${b.getSouth()},${b.getEast()},${b.getNorth()},EPSG:4326`;
  const url=`${WFS}&typeName=ogdwien:KURZPARKSTREIFENOGD&BBOX=${bbox}`;
  for(const p of PROXIES){
    try{
      const r=await fetch(p(url));if(!r.ok)throw 0;
      const d=await r.json();if(!d.features)throw 0;
      if(zoneLayer)map.removeLayer(zoneLayer);
      zoneLayer=L.geoJSON(d,{style:{color:'#ff5f5f',weight:2,fillColor:'#ff5f5f',fillOpacity:.25,opacity:.9}}).addTo(map);
      break;
    }catch(e){}
  }
}

function placeMarker(lat,lng,acc){
  if(userMarker)map.removeLayer(userMarker);
  userMarker=L.circleMarker([lat,lng],{radius:10,color:'#f0c844',fillColor:'#f0c844',fillOpacity:.9,weight:3}).addTo(map);
  document.getElementById('latVal').textContent=lat.toFixed(5);
  document.getElementById('lonVal').textContent=lng.toFixed(5);
  document.getElementById('accVal').textContent=acc?`¬±${Math.round(acc)}m`:'Karten-Klick';
}

// ‚îÄ‚îÄ API ‚îÄ‚îÄ
async function checkPoint(lat,lng){
  if(!selectedBezirk){showResult('','‚ö†Ô∏è','Bezirk fehlt','Tippe oben auf "Bezirk w√§hlen"');return;}
  showResult('checking','‚è≥','Pr√ºfe Zone‚Ä¶','Anfrage l√§uft‚Ä¶');
  document.getElementById('apiStatusVal').textContent='l√§uft‚Ä¶';
  const delta=0.001;
  const bbox=`${lng-delta},${lat-delta},${lng+delta},${lat+delta},EPSG:4326`;
  const url=`${WFS}&typeName=ogdwien:PARKENBERECHTOGD&BBOX=${bbox}`;
  let data=null;
  for(let i=0;i<PROXIES.length;i++){
    try{
      const ctrl=new AbortController();const t=setTimeout(()=>ctrl.abort(),12000);
      const res=await fetch(PROXIES[i](url),{signal:ctrl.signal});clearTimeout(t);
      if(!res.ok)throw 0;const p=JSON.parse(await res.text());if(!p.features)throw 0;
      data=p;document.getElementById('apiStatusVal').textContent=`OK (P${i+1})`;break;
    }catch(e){}
  }
  document.getElementById('lastCheckVal').textContent=new Date().toLocaleTimeString('de-AT');
  if(!data){showResult('','üö´','Nicht erreichbar','API offline');document.getElementById('apiStatusVal').textContent='fehlgeschlagen';showToast('API nicht erreichbar','error');return;}
  const inZone=data.features.filter(f=>pointInFeature([lng,lat],f));
  if(!inZone.length){showResult('outside','‚ùå','Keine Pickerlzone','Hier gilt keine Kurzparkzonen-Berechtigungszone');haptic('light');sendNotif('Kein Pickerl n√∂tig','Keine Zone hier.');return;}
  const hasBez=inZone.some(f=>Object.keys(f.properties).some(k=>/bez/i.test(k)));
  if(!hasBez){showResult('inside','üÖøÔ∏è','Zone vorhanden','Kurzparkzone ‚Äì Bezirk nicht im Datensatz');haptic('medium');return;}
  const match=inZone.filter(f=>Object.keys(f.properties).some(k=>/bez/i.test(k)&&parseInt(f.properties[k])===parseInt(selectedBezirk)));
  if(match.length){showResult('inside',' <img src="check32.png" width="32" height="32">','Pickerlzone g√ºltig!',`Dein ${selectedBezirk}. Bezirk Pickerlzone gilt hier`);haptic('success');sendNotif('<img src="check32.png" width="32" height="32"> G√ºltig!',`${selectedBezirk}. Bezirk Pickerl gilt hier.`);}
  else{const o=getBez(inZone[0]);showResult('outside','‚ùå','Andere Pickerlzone',o?`Zone des ${o}. Bezirks`:'Andere Pickerlzone');haptic('error');sendNotif('‚ùå Falsche Zone',o?`Zone ${o}. Bezirk`:'Andere Zone');}
}

function getBez(f){for(const k of Object.keys(f.properties)){if(/bez/i.test(k)&&f.properties[k]){try{return parseInt(f.properties[k]);}catch(e){}}}return null;}
function pointInRing(pt,ring){const[x,y]=pt;let ins=false,j=ring.length-1;for(let i=0;i<ring.length;j=i++){const[xi,yi]=ring[i],[xj,yj]=ring[j];if(((yi>y)!=(yj>y))&&(x<(xj-xi)*(y-yi)/(yj-yi)+xi))ins=!ins;}return ins;}
function pointInFeature(pt,f){const g=f.geometry;if(!g)return false;if(g.type==='Polygon')return pointInRing(pt,g.coordinates[0]);if(g.type==='MultiPolygon')return g.coordinates.some(p=>pointInRing(pt,p[0]));return false;}

// ‚îÄ‚îÄ GPS ECHTZEIT-TRACKING ‚îÄ‚îÄ
let watchId = null;
let lastLat = null, lastLng = null;
let followMode = true; // Karte folgt dem User

function startTracking() {
  if (!selectedBezirk) { showToast('Bitte zuerst Bezirk ausw√§hlen!','info'); openBezirkSheet(); return; }
  if (watchId !== null) return; // bereits aktiv

  const fab = document.getElementById('gpsFab');
  fab.classList.add('loading'); fab.textContent = 'üì°';
  showResult('checking','üì°','GPS‚Ä¶','Standort wird ermittelt‚Ä¶');

  watchId = navigator.geolocation.watchPosition(pos => {
    fab.classList.remove('loading'); fab.textContent = 'üìç';
    const { latitude: lat, longitude: lng, accuracy: acc } = pos.coords;

    placeMarker(lat, lng, acc);
    savePos(lat, lng);

    // Karte folgt dem User wenn followMode aktiv
    if (followMode) map.setView([lat, lng], 16, { animate: true });

    // Sofort pr√ºfen beim ersten Fix, danach nur wenn >30m bewegt
    const moved = lastLat === null || distanceM(lat, lng, lastLat, lastLng) > 30;
    lastLat = lat; lastLng = lng;
    if (moved) {
      checkPoint(lat, lng);
    }
  }, err => {
    fab.classList.remove('loading'); fab.textContent = 'üìç';
    showResult('','üö´','GPS nicht verf√ºgbar','Einstellungen ‚Üí Datenschutz ‚Üí Ortungsdienste ‚Üí Safari: Erlauben');
    showToast('GPS blockiert!','error');
    watchId = null;
  }, { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 });

  // Wenn User die Karte manuell bewegt ‚Üí followMode aus
  map.on('dragstart', () => { followMode = false; document.getElementById('gpsFab').textContent = 'üîí'; });
}

function getLocation() {
  // GPS-Button: followMode wieder einschalten und Karte auf Standort zentrieren
  followMode = true;
  document.getElementById('gpsFab').textContent = 'üìç';
  if (watchId === null) {
    startTracking();
  } else if (lastLat !== null) {
    map.setView([lastLat, lastLng], 16, { animate: true });
  }
}

// Distanz in Metern zwischen zwei GPS-Punkten
function distanceM(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLng = (lng2-lng1) * Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// ‚îÄ‚îÄ Haptic ‚îÄ‚îÄ
function haptic(t){if(!('vibrate'in navigator))return;({light:[10],medium:[20],success:[10,50,10],error:[50,30,50]}[t]||[10]).length&&navigator.vibrate(({light:[10],medium:[20],success:[10,50,10],error:[50,30,50]}[t]||[10]));}

// ‚îÄ‚îÄ Result Card ‚îÄ‚îÄ
function showResult(cls,icon,title,sub){
  const c=document.getElementById('resultCard');
  c.className='visible'+(cls?' '+cls:'');
  document.getElementById('resultIcon').innerHTML=icon;
  document.getElementById('resultTitle').textContent=title;
  document.getElementById('resultSub').textContent=sub;
}
function hideResult(){document.getElementById('resultCard').classList.remove('visible');}

// ‚îÄ‚îÄ Sheets ‚îÄ‚îÄ
function openSheet(id='detailsSheet'){
  if(activeSheet)closeSheet();
  activeSheet=id;
  document.getElementById(id).classList.add('open');
  document.getElementById('sheetOverlay').classList.add('visible');
  const s=document.getElementById(id);
  s.addEventListener('touchstart',e=>{swipeStartY=e.touches[0].clientY;},{passive:true});
  s.addEventListener('touchend',e=>{if(e.changedTouches[0].clientY-swipeStartY>80)closeSheet();},{passive:true});
}
function openBezirkSheet(){openSheet('bezirkSheet');}
function closeSheet(){
  if(!activeSheet)return;
  document.getElementById(activeSheet).classList.remove('open');
  document.getElementById('sheetOverlay').classList.remove('visible');
  activeSheet=null;
}

// ‚îÄ‚îÄ Storage ‚îÄ‚îÄ
function savePos(lat,lng){try{localStorage.setItem(STORAGE.POS,JSON.stringify({lat,lng,ts:Date.now()}));}catch(e){}}
function clearSavedPos(){try{localStorage.removeItem(STORAGE.POS);}catch(e){}showToast('Cache gel√∂scht','info');document.getElementById('lastCheckVal').textContent='‚Äî';}

// ‚îÄ‚îÄ Notifications ‚îÄ‚îÄ
async function requestNotifications(){
  if(!('Notification'in window)){showToast('Nicht unterst√ºtzt','error');return;}
  const p=await Notification.requestPermission();
  if(p==='granted'){document.getElementById('notifStatusVal').textContent='Aktiv ‚úÖ';showToast('Benachrichtigungen aktiv!','success');new Notification('Parkpickerl Checker',{body:'Aktiv!',icon:'/icon-192.png'});}
  else{document.getElementById('notifStatusVal').textContent='Abgelehnt';showToast('Abgelehnt','error');}
}
function sendNotif(title,body){if(Notification?.permission==='granted')new Notification(title,{body,icon:'/icon-192.png'});}
function updateNotifStatus(){document.getElementById('notifStatusVal').textContent=!('Notification'in window)?'Nicht unterst√ºtzt':Notification.permission==='granted'?'Aktiv ‚úÖ':'Inaktiv';}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
let toastTimer;
function showToast(msg,type='info'){const t=document.getElementById('toast');t.textContent=msg;t.className=`toast ${type} show`;clearTimeout(toastTimer);toastTimer=setTimeout(()=>t.classList.remove('show'),3000);}

// ‚îÄ‚îÄ PWA ‚îÄ‚îÄ
let deferredPrompt=null;
if('serviceWorker'in navigator)navigator.serviceWorker.register('/sw.js').catch(()=>{});
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;if(!window.matchMedia('(display-mode: standalone)').matches)document.getElementById('installBanner').classList.add('visible');});
document.getElementById('installBtn').onclick=async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();const{outcome}=await deferredPrompt.userChoice;if(outcome==='accepted')showToast('App installiert! üéâ','success');document.getElementById('installBanner').classList.remove('visible');deferredPrompt=null;};
document.getElementById('dismissBtn').onclick=()=>document.getElementById('installBanner').classList.remove('visible');
function updateOnline(){const o=!navigator.onLine;document.getElementById('offlineBanner').classList.toggle('visible',o);document.getElementById('mapOffline').classList.toggle('visible',o);}
window.addEventListener('online',updateOnline);window.addEventListener('offline',updateOnline);updateOnline();

// ‚îÄ‚îÄ START ‚îÄ‚îÄ
initMap();
initOnboarding();
updateNotifStatus();
if(new URLSearchParams(location.search).get('action')==='check')setTimeout(getLocation,800);
</script>
</body>
</html>
