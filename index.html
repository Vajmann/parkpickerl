<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#f0c844">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Parkpickerl">
<meta name="description" content="PrÃ¼fe ob dein Wiener Parkpickerl an diesem Ort gilt">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Parkpickerl Checker â€“ Wien</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0e0f13; --surface: #16181f; --border: #252830;
    --text: #e8eaf0; --muted: #6b7080;
    --accent: #f0c844; --green: #3ddc84; --red: #ff5f5f; --blue: #4a9eff;
    --font-d: 'Syne', sans-serif; --font-m: 'DM Mono', monospace;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bot: env(safe-area-inset-bottom, 0px);
  }
  html, body { height: 100%; background: var(--bg); color: var(--text); font-family: var(--font-d); overflow: hidden; }

  /* â”€â”€ Layout â”€â”€ */
  #app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; padding-top: var(--safe-top); }
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 16px; background: var(--surface);
    border-bottom: 1px solid var(--border); gap: 10px; flex-wrap: wrap; flex-shrink: 0;
  }
  .logo { display: flex; align-items: center; gap: 10px; }
  .logo-icon { width: 34px; height: 34px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 800; color: #0e0f13; }
  .logo h1 { font-size: 16px; font-weight: 800; letter-spacing: -0.5px; }
  .logo span { font-size: 10px; color: var(--muted); font-family: var(--font-m); }

  /* â”€â”€ Bezirk Select â”€â”€ */
  .top-controls { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  select { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 8px 10px; border-radius: 8px; font-family: var(--font-d); font-size: 13px; cursor: pointer; outline: none; max-width: 180px; }
  select:focus { border-color: var(--accent); }

  /* â”€â”€ Main content â”€â”€ */
  .content { flex: 1; display: grid; grid-template-rows: auto 1fr; overflow: hidden; }

  /* â”€â”€ Status Bar (oben Ã¼ber Karte) â”€â”€ */
  .status-bar {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 12px 16px; display: flex; align-items: center; gap: 12px; flex-shrink: 0;
  }
  .status-icon-sm { font-size: 28px; flex-shrink: 0; }
  .status-info { flex: 1; min-width: 0; }
  .status-text-sm { font-size: 15px; font-weight: 800; letter-spacing: -0.3px; }
  .status-sub-sm { font-size: 11px; color: var(--muted); font-family: var(--font-m); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .status-bar.inside  { border-left: 4px solid var(--green); }
  .status-bar.outside { border-left: 4px solid var(--red); }
  .status-bar.checking { border-left: 4px solid var(--accent); }

  #checkBtn {
    background: var(--accent); color: #0e0f13; border: none; border-radius: 10px;
    padding: 10px 14px; font-family: var(--font-d); font-weight: 700; font-size: 13px;
    cursor: pointer; flex-shrink: 0; transition: opacity 0.2s; white-space: nowrap;
  }
  #checkBtn:disabled { opacity: 0.5; cursor: default; }
  #checkBtn:active { opacity: 0.8; }

  /* â”€â”€ Karte â”€â”€ */
  #map { width: 100%; height: 100%; }

  /* â”€â”€ Bottom Sheet â”€â”€ */
  .bottom-sheet {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: var(--surface); border-top: 1px solid var(--border);
    border-radius: 20px 20px 0 0;
    padding: 0 16px calc(16px + var(--safe-bot));
    transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
    z-index: 1000; max-height: 70vh; overflow-y: auto;
  }
  .bottom-sheet.open { transform: translateY(0); }
  .sheet-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 12px auto 16px; }
  .sheet-title { font-size: 16px; font-weight: 800; margin-bottom: 16px; }
  .info-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
  .info-row:last-child { border-bottom: none; }
  .info-row .key { color: var(--muted); font-family: var(--font-m); }
  .info-row .val { font-weight: 600; font-size: 12px; font-family: var(--font-m); color: var(--blue); }
  .sheet-close { position: absolute; top: 14px; right: 16px; background: var(--border); border: none; color: var(--text); width: 28px; height: 28px; border-radius: 50%; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

  /* â”€â”€ Toast â”€â”€ */
  .toast {
    position: fixed; bottom: calc(20px + var(--safe-bot)); left: 50%; transform: translateX(-50%) translateY(100px);
    background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 12px 20px; font-size: 13px; font-family: var(--font-m);
    transition: transform 0.3s; z-index: 2000; white-space: nowrap; max-width: 90vw;
    overflow: hidden; text-overflow: ellipsis;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast.success { border-color: var(--green); color: var(--green); }
  .toast.error   { border-color: var(--red);   color: var(--red); }
  .toast.info    { border-color: var(--accent); color: var(--accent); }

  /* â”€â”€ Install Banner â”€â”€ */
  #installBanner {
    display: none; background: linear-gradient(135deg, #1a1d24, #1e2128);
    border-bottom: 1px solid var(--accent); padding: 10px 16px;
    align-items: center; gap: 10px; flex-shrink: 0;
  }
  #installBanner.visible { display: flex; }
  #installBanner p { flex: 1; font-size: 12px; color: var(--text); font-family: var(--font-m); }
  #installBanner p strong { color: var(--accent); }
  .btn-install { background: var(--accent); color: #0e0f13; border: none; border-radius: 8px; padding: 7px 14px; font-weight: 700; font-size: 12px; cursor: pointer; font-family: var(--font-d); }
  .btn-dismiss { background: none; border: none; color: var(--muted); font-size: 18px; cursor: pointer; padding: 4px; }

  /* â”€â”€ Offline-Banner â”€â”€ */
  #offlineBanner {
    display: none; background: #2a1515; border-bottom: 1px solid var(--red);
    padding: 8px 16px; text-align: center; font-size: 12px; color: var(--red);
    font-family: var(--font-m); flex-shrink: 0;
  }
  #offlineBanner.visible { display: block; }

  /* â”€â”€ FAB (Info-Button) â”€â”€ */
  #fab {
    position: fixed; bottom: calc(20px + var(--safe-bot)); right: 16px;
    width: 52px; height: 52px; background: var(--surface); border: 1px solid var(--border);
    border-radius: 50%; font-size: 22px; cursor: pointer; display: flex;
    align-items: center; justify-content: center; z-index: 500;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4); transition: transform 0.2s;
  }
  #fab:active { transform: scale(0.92); }
</style>
</head>
<body>
<div id="app">
  <!-- Offline Banner -->
  <div id="offlineBanner">ğŸ“µ Offline â€“ Karte aus Cache, API nicht verfÃ¼gbar</div>

  <!-- Install Banner -->
  <div id="installBanner">
    <p>ğŸ“± <strong>App installieren</strong> â€“ am Homescreen verfÃ¼gbar, offline nutzbar!</p>
    <button class="btn-install" id="installBtn">Installieren</button>
    <button class="btn-dismiss" id="dismissBtn">âœ•</button>
  </div>

  <header>
    <div class="logo">
      <div class="logo-icon">P</div>
      <div>
        <h1>Parkpickerl</h1>
        <span>Wien Â· Kurzparkzonen</span>
      </div>
    </div>
    <div class="top-controls">
      <select id="bezirkSelect" onchange="onBezirkChange()">
        <option value="">Bezirk wÃ¤hlen</option>
        <option value="1">1. Innere Stadt</option>
        <option value="2">2. Leopoldstadt</option>
        <option value="3">3. LandstraÃŸe</option>
        <option value="4">4. Wieden</option>
        <option value="5">5. Margareten</option>
        <option value="6">6. Mariahilf</option>
        <option value="7">7. Neubau</option>
        <option value="8">8. Josefstadt</option>
        <option value="9">9. Alsergrund</option>
        <option value="10">10. Favoriten</option>
        <option value="11">11. Simmering</option>
        <option value="12">12. Meidling</option>
        <option value="13">13. Hietzing</option>
        <option value="14">14. Penzing</option>
        <option value="15">15. Rudolfsheim-FÃ¼nfhaus</option>
        <option value="16">16. Ottakring</option>
        <option value="17">17. Hernals</option>
        <option value="18">18. WÃ¤hring</option>
        <option value="19">19. DÃ¶bling</option>
        <option value="20">20. Brigittenau</option>
        <option value="21">21. Floridsdorf</option>
        <option value="22">22. Donaustadt</option>
        <option value="23">23. Liesing</option>
      </select>
    </div>
  </header>

  <div class="content">
    <!-- Status Bar -->
    <div class="status-bar" id="statusBar">
      <span class="status-icon-sm" id="statusIcon">ğŸ…¿ï¸</span>
      <div class="status-info">
        <div class="status-text-sm" id="statusText">Bereit</div>
        <div class="status-sub-sm" id="statusSub">Bezirk wÃ¤hlen &amp; auf Standort tippen</div>
      </div>
      <button id="checkBtn" onclick="getLocation()">ğŸ“ PrÃ¼fen</button>
    </div>

    <!-- Karte -->
    <div id="map"></div>
  </div>

  <!-- FAB Info -->
  <button id="fab" onclick="openSheet()">â„¹ï¸</button>

  <!-- Bottom Sheet -->
  <div class="bottom-sheet" id="bottomSheet">
    <button class="sheet-close" onclick="closeSheet()">âœ•</button>
    <div class="sheet-handle"></div>
    <div class="sheet-title">Details</div>
    <div class="info-row"><span class="key">Breitengrad</span><span class="val" id="latVal">â€”</span></div>
    <div class="info-row"><span class="key">LÃ¤ngengrad</span><span class="val" id="lonVal">â€”</span></div>
    <div class="info-row"><span class="key">Genauigkeit</span><span class="val" id="accVal">â€”</span></div>
    <div class="info-row"><span class="key">Letzter Check</span><span class="val" id="lastCheckVal">â€”</span></div>
    <div class="info-row"><span class="key">API-Status</span><span class="val" id="apiStatusVal">â€”</span></div>
    <div class="info-row"><span class="key">Gespeicherter Bezirk</span><span class="val" id="savedBezirkVal">â€”</span></div>
    <div class="info-row"><span class="key">Benachrichtigungen</span><span class="val" id="notifStatusVal">â€”</span></div>
    <div class="info-row" style="padding-top:16px">
      <button onclick="requestNotifications()" style="background:var(--accent);color:#0e0f13;border:none;border-radius:8px;padding:8px 14px;font-family:var(--font-d);font-weight:700;font-size:12px;cursor:pointer;">
        ğŸ”” Benachrichtigungen aktivieren
      </button>
      <button onclick="clearSavedPos()" style="background:var(--surface);color:var(--red);border:1px solid var(--red);border-radius:8px;padding:8px 14px;font-family:var(--font-d);font-size:12px;cursor:pointer;">
        ğŸ—‘ Gespeichert lÃ¶schen
      </button>
    </div>
    <div style="padding:16px 0 4px;font-size:10px;color:var(--muted);font-family:var(--font-m);">Daten: OGD Wien Â· data.wien.gv.at</div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE â€“ Bezirk & letzter Standort persistent speichern
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORAGE_KEYS = { BEZIRK: 'pp_bezirk', LAST_POS: 'pp_lastpos', NOTIF: 'pp_notif' };

function loadSaved() {
  try {
    const b = localStorage.getItem(STORAGE_KEYS.BEZIRK);
    if (b) {
      selectedBezirk = b;
      document.getElementById('bezirkSelect').value = b;
      document.getElementById('savedBezirkVal').textContent = `${b}. Bezirk`;
      // Highlight wird nach Bezirksgrenzen-Load gemacht (in loadBezirksgrenzen)
    }
    const pos = localStorage.getItem(STORAGE_KEYS.LAST_POS);
    if (pos) {
      const { lat, lng, ts } = JSON.parse(pos);
      const ago = Math.round((Date.now() - ts) / 60000);
      placeMarker(lat, lng, null);
      map.setView([lat, lng], 15);
      document.getElementById('lastCheckVal').textContent = ago < 60 ? `vor ${ago} min` : `vor ${Math.round(ago/60)} Std`;
    }
  } catch(e) {}
}

function savePos(lat, lng) {
  try { localStorage.setItem(STORAGE_KEYS.LAST_POS, JSON.stringify({ lat, lng, ts: Date.now() })); } catch(e) {}
}

function clearSavedPos() {
  try { localStorage.removeItem(STORAGE_KEYS.LAST_POS); } catch(e) {}
  showToast('Gespeicherter Standort gelÃ¶scht', 'info');
  document.getElementById('lastCheckVal').textContent = 'â€”';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVICE WORKER & PWA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let deferredInstallPrompt = null;

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').then(reg => {
    console.log('[PWA] Service Worker registriert');
  }).catch(e => console.warn('[PWA] SW Fehler:', e));
}

// Install-Prompt abfangen
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredInstallPrompt = e;
  // Banner nur zeigen wenn noch nicht installiert
  if (!window.matchMedia('(display-mode: standalone)').matches) {
    document.getElementById('installBanner').classList.add('visible');
  }
});

document.getElementById('installBtn').onclick = async () => {
  if (!deferredInstallPrompt) return;
  deferredInstallPrompt.prompt();
  const { outcome } = await deferredInstallPrompt.userChoice;
  if (outcome === 'accepted') showToast('App wird installiert! ğŸ‰', 'success');
  document.getElementById('installBanner').classList.remove('visible');
  deferredInstallPrompt = null;
};

document.getElementById('dismissBtn').onclick = () => {
  document.getElementById('installBanner').classList.remove('visible');
};

// Offline/Online erkennen
function updateOnlineStatus() {
  document.getElementById('offlineBanner').classList.toggle('visible', !navigator.onLine);
}
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);
updateOnlineStatus();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PUSH-BENACHRICHTIGUNGEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function requestNotifications() {
  if (!('Notification' in window)) {
    showToast('Benachrichtigungen nicht unterstÃ¼tzt', 'error'); return;
  }
  const perm = await Notification.requestPermission();
  if (perm === 'granted') {
    document.getElementById('notifStatusVal').textContent = 'Aktiv âœ…';
    try { localStorage.setItem(STORAGE_KEYS.NOTIF, '1'); } catch(e) {}
    showToast('Benachrichtigungen aktiviert!', 'success');
    // Test-Benachrichtigung
    new Notification('Parkpickerl Checker', {
      body: 'Benachrichtigungen aktiv! Du wirst erinnert wenn nÃ¶tig.',
      icon: '/icon-192.png'
    });
  } else {
    showToast('Benachrichtigungen abgelehnt', 'error');
    document.getElementById('notifStatusVal').textContent = 'Abgelehnt âŒ';
  }
}

function sendNotification(title, body) {
  if (Notification.permission === 'granted') {
    new Notification(title, { body, icon: '/icon-192.png' });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KARTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let map, userMarker;
let selectedBezirk = null;
let bezirkLayer = null;    // Bezirksgrenzen GeoJSON
let highlightLayer = null; // Hervorgehobener Bezirk
let zoneLayer = null;      // Pickerlzonen des gewÃ¤hlten Bezirks
let allBezirke = null;     // Gecachte Bezirksdaten

// Bezirkszentren fÃ¼r Zoom
const BEZIRK_CENTERS = {
  1:[48.2085,16.3725], 2:[48.2150,16.3950], 3:[48.1980,16.3980],
  4:[48.1920,16.3660], 5:[48.1880,16.3560], 6:[48.1970,16.3490],
  7:[48.2020,16.3480], 8:[48.2090,16.3510], 9:[48.2220,16.3570],
  10:[48.1620,16.3820], 11:[48.1730,16.4280], 12:[48.1720,16.3370],
  13:[48.1780,16.2980], 14:[48.2050,16.3050], 15:[48.1970,16.3270],
  16:[48.2120,16.3120], 17:[48.2270,16.3180], 18:[48.2330,16.3380],
  19:[48.2500,16.3600], 20:[48.2280,16.3750], 21:[48.2670,16.4020],
  22:[48.2270,16.4650], 23:[48.1480,16.2980]
};

function initMap() {
  map = L.map('map', { center: [48.2082, 16.3738], zoom: 12, zoomControl: true });
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: 'Â© OpenStreetMap, Â© CARTO', subdomains: 'abcd', maxZoom: 19
  }).addTo(map);

  // WMS Kurzparkzonen (alle, gedimmt im Hintergrund)
  L.tileLayer.wms('https://data.wien.gv.at/daten/geo', {
    layers: 'ogdwien:KURZPARKZONEOGD',
    format: 'image/png', transparent: true, opacity: 0.2
  }).addTo(map);

  map.on('click', e => {
    placeMarker(e.latlng.lat, e.latlng.lng, null);
    savePos(e.latlng.lat, e.latlng.lng);
    checkPoint(e.latlng.lat, e.latlng.lng);
  });

  // Bezirksgrenzen laden (klein, ~50KB, einmalig)
  loadBezirksgrenzen();
}

async function loadBezirksgrenzen() {
  const url = 'https://data.wien.gv.at/daten/geo?service=WFS&request=GetFeature&version=1.1.0&outputFormat=application/json&srsName=EPSG:4326&typeName=ogdwien:BEZIRKSGRENZEOGD';
  const proxies = [
    u => `https://corsproxy.io/?url=${encodeURIComponent(u)}`,
    u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
    u => `https://thingproxy.freeboard.io/fetch/${u}`,
  ];
  for (const proxy of proxies) {
    try {
      const res = await fetch(proxy(url));
      if (!res.ok) throw new Error();
      const data = await res.json();
      if (!data.features) throw new Error();
      allBezirke = data;
      // Alle Bezirksgrenzen dÃ¼nn anzeigen
      bezirkLayer = L.geoJSON(data, {
        style: { color: '#4a9eff', weight: 1, fillOpacity: 0, opacity: 0.4 }
      }).addTo(map);
      console.log('Bezirksgrenzen geladen:', data.features.length);
      // Falls Bezirk schon gewÃ¤hlt, sofort highlighten
      if (selectedBezirk) highlightBezirk(selectedBezirk);
      break;
    } catch(e) { console.warn('Bezirksgrenzen Proxy fehlgeschlagen'); }
  }
}

function highlightBezirk(bez) {
  if (!allBezirke) return;
  // Alten Highlight entfernen
  if (highlightLayer) { map.removeLayer(highlightLayer); highlightLayer = null; }
  if (zoneLayer) { map.removeLayer(zoneLayer); zoneLayer = null; }

  // Bezirk-Feature finden (verschiedene mÃ¶gliche Property-Namen)
  const feature = allBezirke.features.find(f => {
    const p = f.properties;
    const b = p.BEZNR ?? p.BEZ ?? p.BEZIRK ?? p.beznr ?? p.bez;
    return parseInt(b) === parseInt(bez);
  });

  if (!feature) { console.warn('Bezirk nicht gefunden:', bez); return; }

  // Hervorheben: gelb mit FÃ¼llung
  highlightLayer = L.geoJSON(feature, {
    style: {
      color: '#f0c844', weight: 3,
      fillColor: '#f0c844', fillOpacity: 0.12,
      opacity: 0.9
    }
  }).addTo(map);

  // Zoom auf Bezirk
  map.fitBounds(highlightLayer.getBounds(), { padding: [30, 30] });

  // Pickerlzonen NUR fÃ¼r diesen Bezirk laden & grÃ¼n einfÃ¤rben
  loadZonesForBezirk(bez, feature);
}

async function loadZonesForBezirk(bez, bezFeature) {
  // BBox des Bezirks berechnen
  const bounds = L.geoJSON(bezFeature).getBounds();
  const bbox = `${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()},EPSG:4326`;
  const url = `https://data.wien.gv.at/daten/geo?service=WFS&request=GetFeature&version=1.1.0&outputFormat=application/json&srsName=EPSG:4326&typeName=ogdwien:PARKENBERECHTOGD&BBOX=${bbox}`;
  const proxies = [
    u => `https://corsproxy.io/?url=${encodeURIComponent(u)}`,
    u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
    u => `https://thingproxy.freeboard.io/fetch/${u}`,
  ];
  for (const proxy of proxies) {
    try {
      const res = await fetch(proxy(url));
      if (!res.ok) throw new Error();
      const data = await res.json();
      if (!data.features) throw new Error();
      if (zoneLayer) map.removeLayer(zoneLayer);
      zoneLayer = L.geoJSON(data, {
        style: {
          color: '#3ddc84', weight: 1.5,
          fillColor: '#3ddc84', fillOpacity: 0.25,
          opacity: 0.8
        }
      }).addTo(map);
      console.log(`Zonen fÃ¼r Bezirk ${bez}:`, data.features.length);
      break;
    } catch(e) { console.warn('Zonen laden fehlgeschlagen'); }
  }
}

function placeMarker(lat, lng, acc) {
  if (userMarker) map.removeLayer(userMarker);
  userMarker = L.circleMarker([lat, lng], {
    radius: 11, color: '#f0c844', fillColor: '#f0c844', fillOpacity: 0.85, weight: 3
  }).addTo(map);
  document.getElementById('latVal').textContent = lat.toFixed(5);
  document.getElementById('lonVal').textContent = lng.toFixed(5);
  document.getElementById('accVal').textContent = acc ? `Â±${Math.round(acc)}m` : 'Karten-Klick';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API-ABFRAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WFS_BASE = 'https://data.wien.gv.at/daten/geo?service=WFS&request=GetFeature&version=1.1.0&outputFormat=application/json&srsName=EPSG:4326';
const PROXIES = [
  url => `https://corsproxy.io/?url=${encodeURIComponent(url)}`,
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url => `https://thingproxy.freeboard.io/fetch/${url}`,
];

async function checkPoint(lat, lng) {
  if (!selectedBezirk) {
    setStatus('', 'âš ï¸', 'Bezirk fehlt', 'Bitte oben Bezirk wÃ¤hlen');
    return;
  }
  setStatus('checking', 'â³', 'PrÃ¼feâ€¦', 'Anfrage lÃ¤uftâ€¦');
  document.getElementById('apiStatusVal').textContent = 'lÃ¤uftâ€¦';

  const delta = 0.001;
  const bbox = `${lng-delta},${lat-delta},${lng+delta},${lat+delta},EPSG:4326`;
  const url = `${WFS_BASE}&typeName=ogdwien:PARKENBERECHTOGD&BBOX=${bbox}`;

  let data = null;
  for (let i = 0; i < PROXIES.length; i++) {
    try {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), 12000);
      const res = await fetch(PROXIES[i](url), { signal: ctrl.signal });
      clearTimeout(t);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const parsed = JSON.parse(await res.text());
      if (!parsed.features) throw new Error('Kein GeoJSON');
      data = parsed;
      document.getElementById('apiStatusVal').textContent = `OK (P${i+1})`;
      break;
    } catch(e) { console.warn(`Proxy ${i+1}:`, e.message); }
  }

  const now = new Date().toLocaleTimeString('de-AT');
  document.getElementById('lastCheckVal').textContent = now;

  if (!data) {
    setStatus('', 'ğŸš«', 'Offline?', 'API nicht erreichbar');
    document.getElementById('apiStatusVal').textContent = 'fehlgeschlagen';
    showToast('API nicht erreichbar â€“ offline?', 'error');
    return;
  }

  const inZone = data.features.filter(f => pointInFeature([lng, lat], f));

  if (!inZone.length) {
    setStatus('outside', 'âŒ', 'Keine Pickerlzone', 'Hier gilt keine Kurzparkzonen-Berechtigungszone');
    sendNotification('Kein Pickerl nÃ¶tig', 'An diesem Ort gilt keine Kurzparkzone.');
    return;
  }

  const hasBezField = inZone.some(f => Object.keys(f.properties).some(k => /bez/i.test(k)));
  if (!hasBezField) {
    setStatus('inside', 'ğŸ…¿ï¸', 'Zone gefunden!', 'Kurzparkzone vorhanden (Bezirk im Datensatz nicht angegeben)');
    sendNotification('Parkpickerl-Zone!', 'Du bist in einer Kurzparkzone.');
    return;
  }

  const bezMatch = inZone.filter(f => {
    const p = f.properties;
    return Object.keys(p).some(k => /bez/i.test(k) && parseInt(p[k]) === parseInt(selectedBezirk));
  });

  if (bezMatch.length) {
    setStatus('inside', 'âœ…', 'Pickerlzone gÃ¼ltig!', `Dein ${selectedBezirk}. Bezirk Pickerlzone gilt hier`);
    sendNotification('âœ… Pickerlzone gÃ¼ltig!', `Dein ${selectedBezirk}. Bezirk Parkpickerl gilt hier.`);
  } else {
    const other = getZoneBezirk(inZone[0]);
    setStatus('outside', 'âŒ', 'Andere Zone', other ? `Hier gilt Zone des ${other}. Bezirks` : 'Hier gilt eine andere Pickerlzone');
    sendNotification('âŒ Falsches Pickerlgebiet', `Hier gilt ${other ? `Zone des ${other}. Bezirks` : 'eine andere Zone'}.`);
  }
}

function getZoneBezirk(f) {
  const p = f.properties;
  for (const k of Object.keys(p)) { if (/bez/i.test(k) && p[k]) { try { return parseInt(p[k]); } catch(e) {} } }
  return null;
}

function pointInRing(pt, ring) {
  const [x, y] = pt; let inside = false, j = ring.length - 1;
  for (let i = 0; i < ring.length; j = i++) {
    const [xi,yi] = ring[i], [xj,yj] = ring[j];
    if (((yi>y)!=(yj>y)) && (x < (xj-xi)*(y-yi)/(yj-yi)+xi)) inside = !inside;
  }
  return inside;
}

function pointInFeature(pt, f) {
  const g = f.geometry;
  if (!g) return false;
  if (g.type==='Polygon') return pointInRing(pt, g.coordinates[0]);
  if (g.type==='MultiPolygon') return g.coordinates.some(p => pointInRing(pt, p[0]));
  return false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getLocation() {
  if (!selectedBezirk) { showToast('Bitte zuerst Bezirk wÃ¤hlen!', 'info'); return; }
  const btn = document.getElementById('checkBtn');
  btn.disabled = true; btn.textContent = 'ğŸ“¡â€¦';
  setStatus('checking', 'ğŸ“¡', 'GPSâ€¦', 'Standort wird ermitteltâ€¦');
  navigator.geolocation.getCurrentPosition(pos => {
    btn.disabled = false; btn.textContent = 'ğŸ“ PrÃ¼fen';
    const { latitude: lat, longitude: lng, accuracy: acc } = pos.coords;
    placeMarker(lat, lng, acc);
    savePos(lat, lng);
    map.setView([lat, lng], 15);
    checkPoint(lat, lng);
  }, () => {
    btn.disabled = false; btn.textContent = 'ğŸ“ PrÃ¼fen';
    setStatus('', 'ğŸš«', 'GPS fehlt', 'Klicke auf die Karte!');
    showToast('GPS nicht verfÃ¼gbar â€“ Karte antippen!', 'error');
  }, { enableHighAccuracy: true, timeout: 10000 });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatus(cls, icon, text, sub) {
  const bar = document.getElementById('statusBar');
  bar.className = 'status-bar' + (cls ? ' '+cls : '');
  document.getElementById('statusIcon').textContent = icon;
  document.getElementById('statusText').textContent = text;
  document.getElementById('statusSub').textContent = sub;
}

let toastTimer;
function showToast(msg, type = 'info') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = `toast ${type} show`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

function openSheet()  { document.getElementById('bottomSheet').classList.add('open'); }
function closeSheet() { document.getElementById('bottomSheet').classList.remove('open'); }

// Sheet schliessen bei Aussenklick
document.addEventListener('click', e => {
  const sheet = document.getElementById('bottomSheet');
  if (sheet.classList.contains('open') && !sheet.contains(e.target) && e.target.id !== 'fab') closeSheet();
});

function onBezirkChange() {
  selectedBezirk = document.getElementById('bezirkSelect').value || null;
  if (selectedBezirk) {
    try { localStorage.setItem(STORAGE_KEYS.BEZIRK, selectedBezirk); } catch(e) {}
    document.getElementById('savedBezirkVal').textContent = `${selectedBezirk}. Bezirk`;
    showToast(`${selectedBezirk}. Bezirk wird hervorgehobenâ€¦`, 'info');
    highlightBezirk(selectedBezirk);
  } else {
    // Bezirk abgewÃ¤hlt â€“ Highlights entfernen
    if (highlightLayer) { map.removeLayer(highlightLayer); highlightLayer = null; }
    if (zoneLayer) { map.removeLayer(zoneLayer); zoneLayer = null; }
  }
}

// Benachrichtigungsstatus anzeigen
function updateNotifStatus() {
  const v = 'Notification' in window ? Notification.permission === 'granted' ? 'Aktiv âœ…' : 'Inaktiv' : 'Nicht unterstÃ¼tzt';
  document.getElementById('notifStatusVal').textContent = v;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initMap();
loadSaved();
updateNotifStatus();

// Schnell-Check aus URL-Parameter (Shortcut)
if (new URLSearchParams(location.search).get('action') === 'check') {
  setTimeout(getLocation, 500);
}
</script>
</body>
</html>
