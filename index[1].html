<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#E2001A">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Parkpickerl">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Parkpickerl Checker ‚Äì Wien</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --red:#E2001A;--green:#2e7d32;--yellow:#f0c844;--blue:#1565c0;
  --bg:#f5f5f7;--surface:#fff;--border:#e0e0e5;--text:#1a1a2e;--muted:#8888aa;
  --safe-top:env(safe-area-inset-top,0px);--safe-bot:env(safe-area-inset-bottom,0px);
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;overflow:hidden;-webkit-tap-highlight-color:transparent}
#app{display:flex;flex-direction:column;height:100vh;height:100dvh;padding-top:var(--safe-top)}
header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--red);gap:10px;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,.2)}
.logo{display:flex;align-items:center;gap:10px}
.logo-icon{width:34px;height:34px;background:#fff;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:900;color:var(--red)}
.logo h1{font-size:16px;font-weight:800;color:#fff;letter-spacing:-.3px}
.logo span{font-size:10px;color:rgba(255,255,255,.7);display:block}
#bezirkBtn{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.2);border:1.5px solid rgba(255,255,255,.5);color:#fff;padding:8px 14px;border-radius:50px;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap}
#bezirkBtn.sel{background:rgba(255,255,255,.3);border-color:#fff}
.bez-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.5);flex-shrink:0;transition:background .2s}
#bezirkBtn.sel .bez-dot{background:#fff}
.content{flex:1;position:relative;overflow:hidden}
#map{width:100%;height:100%}
#resultCard{
  position:absolute;top:16px;left:16px;right:16px;
  background:rgba(255,255,255,.96);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border:1.5px solid var(--border);border-radius:16px;padding:14px 16px;
  display:flex;align-items:center;gap:12px;z-index:400;
  transform:translateY(-130px);opacity:0;pointer-events:none;
  transition:transform .4s cubic-bezier(.34,1.56,.64,1),opacity .3s;
  box-shadow:0 4px 24px rgba(0,0,0,.12)
}
#resultCard.vis{transform:translateY(0);opacity:1;pointer-events:auto}
#resultCard.ok{border-color:rgba(46,125,50,.4);background:rgba(232,245,233,.96)}
#resultCard.no{border-color:rgba(226,0,26,.35);background:rgba(255,235,235,.96)}
#resultCard.chk{border-color:rgba(240,200,68,.4);background:rgba(255,253,231,.96)}
.r-icon{font-size:32px;flex-shrink:0}
.r-body{flex:1;min-width:0}
.r-title{font-size:15px;font-weight:800}
.r-sub{font-size:11px;color:var(--muted);margin-top:2px;line-height:1.4}
.r-close{background:rgba(0,0,0,.06);border:none;color:var(--muted);width:26px;height:26px;border-radius:50%;font-size:12px;cursor:pointer;flex-shrink:0}
#gpsFab{
  position:absolute;bottom:calc(28px + var(--safe-bot));left:50%;transform:translateX(-50%);
  background:var(--red);color:#fff;border:none;width:64px;height:64px;border-radius:50%;
  font-size:26px;cursor:pointer;z-index:400;box-shadow:0 4px 20px rgba(226,0,26,.5);
  transition:transform .15s;display:flex;align-items:center;justify-content:center;
  -webkit-tap-highlight-color:transparent
}
#gpsFab:active{transform:translateX(-50%) scale(.9)}
#gpsFab.spin{animation:gps-spin 1.2s linear infinite}
@keyframes gps-spin{to{box-shadow:0 0 0 8px rgba(226,0,26,0),0 4px 20px rgba(226,0,26,.5)}}
#settingsFab{
  position:absolute;bottom:calc(28px + var(--safe-bot));right:16px;
  width:48px;height:48px;background:#fff;border:1.5px solid var(--border);border-radius:50%;
  font-size:20px;cursor:pointer;z-index:400;box-shadow:0 2px 10px rgba(0,0,0,.1);
  display:flex;align-items:center;justify-content:center
}
#onboarding{
  position:fixed;inset:0;z-index:2000;background:var(--bg);
  display:flex;flex-direction:column;
  padding:calc(var(--safe-top) + 36px) 24px calc(var(--safe-bot) + 20px);
  transition:opacity .35s,transform .35s
}
#onboarding.gone{opacity:0;transform:scale(.97);pointer-events:none}
.ob-icon{width:68px;height:68px;background:var(--red);border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:34px;font-weight:900;color:#fff;margin-bottom:20px;box-shadow:0 8px 24px rgba(226,0,26,.3)}
.ob-h{font-size:26px;font-weight:800;letter-spacing:-.8px;margin-bottom:6px;line-height:1.2}
.ob-p{font-size:14px;color:var(--muted);line-height:1.6;margin-bottom:20px}
.ob-lbl{font-size:11px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:10px}
.bez-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;overflow-y:auto;flex:1;-webkit-overflow-scrolling:touch;padding-bottom:4px}
.bez-grid::-webkit-scrollbar{display:none}
.bez-btn{background:#fff;border:1.5px solid var(--border);border-radius:12px;padding:10px 4px;text-align:center;cursor:pointer;font-size:11px;font-weight:600;line-height:1.3;transition:border-color .1s,background .1s;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
.bez-btn.sel{border-color:var(--red);background:#fff0f0;color:var(--red)}
.bez-nr{font-size:18px;font-weight:800;display:block;margin-bottom:2px}
#obBtn{
  margin-top:14px;background:var(--red);color:#fff;border:none;border-radius:14px;padding:16px;
  font-weight:800;font-size:16px;cursor:pointer;width:100%;flex-shrink:0;
  opacity:.35;pointer-events:none;transition:opacity .2s;touch-action:manipulation
}
#obBtn.rdy{opacity:1;pointer-events:auto}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:900;opacity:0;pointer-events:none;transition:opacity .3s}
.overlay.vis{opacity:1;pointer-events:auto}
.sheet{position:fixed;bottom:0;left:0;right:0;background:#fff;border-radius:22px 22px 0 0;
  padding:0 20px calc(20px + var(--safe-bot));transform:translateY(100%);
  transition:transform .33s cubic-bezier(.4,0,.2,1);z-index:1000;
  max-height:82vh;overflow-y:auto;-webkit-overflow-scrolling:touch}
.sheet.vis{transform:translateY(0)}
.sh-handle{width:38px;height:4px;background:var(--border);border-radius:2px;margin:14px auto 16px}
.sh-title{font-size:17px;font-weight:800;margin-bottom:18px}
.irow{display:flex;justify-content:space-between;align-items:center;padding:11px 0;border-bottom:1px solid var(--border);font-size:13px}
.irow:last-child{border-bottom:none}
.irow .k{color:var(--muted)}.irow .v{font-weight:600;font-size:12px;color:var(--blue)}
.toast{position:fixed;bottom:calc(108px + var(--safe-bot));left:50%;transform:translateX(-50%) translateY(16px);
  background:rgba(26,26,46,.92);border-radius:50px;padding:10px 20px;font-size:13px;color:#fff;
  opacity:0;transition:transform .3s,opacity .3s;z-index:3000;white-space:nowrap;max-width:90vw;pointer-events:none}
.toast.vis{transform:translateX(-50%) translateY(0);opacity:1}
.toast.ok{background:rgba(46,125,50,.92)}.toast.err{background:rgba(226,0,26,.92)}.toast.inf{background:rgba(21,101,192,.92)}
#offline{display:none;background:#ffebee;border-bottom:1px solid #ffcdd2;padding:7px 16px;text-align:center;font-size:12px;color:#c62828;flex-shrink:0}
#offline.vis{display:block}
</style>
</head>
<body>
<div id="app">

<div id="onboarding">
  <div class="ob-icon">P</div>
  <div class="ob-h">Parkpickerl<br>Checker Wien</div>
  <div class="ob-p">W√§hle deinen Heimatbezirk ‚Äì die App merkt ihn sich.</div>
  <div class="ob-lbl">Mein Bezirk</div>
  <div class="bez-grid" id="obGrid"></div>
  <button id="obBtn">Los geht's ‚Üí</button>
</div>

<div id="offline">üìµ Offline ‚Äì Kartencache aktiv</div>

<header>
  <div class="logo">
    <div class="logo-icon">P</div>
    <div><h1>Parkpickerl</h1><span>Wien ¬∑ Kurzparkzonen</span></div>
  </div>
  <button id="bezirkBtn" onclick="openSheet('shBez')">
    <span class="bez-dot"></span>
    <span id="bezLabel">Bezirk w√§hlen</span>
    <span style="font-size:11px;opacity:.6">‚ñæ</span>
  </button>
</header>

<div class="content">
  <div id="map"></div>
  <div id="resultCard">
    <span class="r-icon" id="rIcon">üÖøÔ∏è</span>
    <div class="r-body">
      <div class="r-title" id="rTitle">Bereit</div>
      <div class="r-sub" id="rSub">Bezirk w√§hlen &amp; GPS tippen</div>
    </div>
    <button class="r-close" onclick="hideResult()">‚úï</button>
  </div>
  <button id="gpsFab" onclick="getGPS()">üìç</button>
  <button id="settingsFab" onclick="openSheet('shInfo')">‚öôÔ∏è</button>
</div>

<div class="overlay" id="overlay" onclick="closeSheet()"></div>

<div class="sheet" id="shBez">
  <div class="sh-handle"></div>
  <div class="sh-title">Bezirk wechseln</div>
  <div class="bez-grid" id="shBezGrid" style="max-height:60vh;padding-bottom:12px"></div>
</div>

<div class="sheet" id="shInfo">
  <div class="sh-handle"></div>
  <div class="sh-title">Details</div>
  <div class="irow"><span class="k">Breitengrad</span><span class="v" id="iLat">‚Äî</span></div>
  <div class="irow"><span class="k">L√§ngengrad</span><span class="v" id="iLng">‚Äî</span></div>
  <div class="irow"><span class="k">Genauigkeit</span><span class="v" id="iAcc">‚Äî</span></div>
  <div class="irow"><span class="k">Letzter Check</span><span class="v" id="iTime">‚Äî</span></div>
  <div class="irow"><span class="k">API Status</span><span class="v" id="iApi">‚Äî</span></div>
  <div class="irow"><span class="k">Mein Bezirk</span><span class="v" id="iBez">‚Äî</span></div>
  <div style="margin-top:14px">
    <button onclick="clearCache()" style="width:100%;padding:12px;border:1.5px solid #ffcdd2;background:#ffebee;color:#c62828;border-radius:10px;font-weight:700;font-size:13px;cursor:pointer">üóë Cache l√∂schen</button>
  </div>
  <div style="padding:14px 0 2px;font-size:10px;color:var(--muted)">Version 5.0 ¬∑ OGD Wien</div>
</div>

<div class="toast" id="toast"></div>
</div>

<script>
// ‚îÄ‚îÄ Daten ‚îÄ‚îÄ
const BEZ=[
  [1,'Innere Stadt'],[2,'Leopoldstadt'],[3,'Landstra√üe'],[4,'Wieden'],
  [5,'Margareten'],[6,'Mariahilf'],[7,'Neubau'],[8,'Josefstadt'],
  [9,'Alsergrund'],[10,'Favoriten'],[11,'Simmering'],[12,'Meidling'],
  [13,'Hietzing'],[14,'Penzing'],[15,'Rudolfsheim-F√ºnfhaus'],[16,'Ottakring'],
  [17,'Hernals'],[18,'W√§hring'],[19,'D√∂bling'],[20,'Brigittenau'],
  [21,'Floridsdorf'],[22,'Donaustadt'],[23,'Liesing']
];

// Echte Grenzen von OGD Wien (https://data.wien.gv.at) ‚Äì korrekte Koordinaten
const GEO={"type":"FeatureCollection","features":[
{"type":"Feature","properties":{"B":1},"geometry":{"type":"Polygon","coordinates":[[[16.3551,48.1986],[16.3569,48.2055],[16.3604,48.2096],[16.3650,48.2122],[16.3703,48.2131],[16.3752,48.2117],[16.3789,48.2087],[16.3804,48.2045],[16.3795,48.2000],[16.3768,48.1961],[16.3728,48.1937],[16.3680,48.1928],[16.3633,48.1938],[16.3594,48.1960],[16.3563,48.1978],[16.3551,48.1986]]]}},
{"type":"Feature","properties":{"B":2},"geometry":{"type":"Polygon","coordinates":[[[16.3795,48.2000],[16.3804,48.2045],[16.3789,48.2087],[16.3810,48.2180],[16.3768,48.2245],[16.3820,48.2305],[16.3900,48.2345],[16.3985,48.2358],[16.4068,48.2325],[16.4128,48.2265],[16.4158,48.2190],[16.4148,48.2110],[16.4108,48.2048],[16.4040,48.1990],[16.3958,48.1955],[16.3882,48.1948],[16.3820,48.1960],[16.3795,48.2000]]]}},
{"type":"Feature","properties":{"B":3},"geometry":{"type":"Polygon","coordinates":[[[16.3768,48.1961],[16.3795,48.2000],[16.3820,48.1960],[16.3882,48.1948],[16.3958,48.1955],[16.4040,48.1990],[16.4108,48.2048],[16.4148,48.2110],[16.4235,48.2042],[16.4315,48.1972],[16.4345,48.1898],[16.4318,48.1828],[16.4252,48.1770],[16.4155,48.1742],[16.4060,48.1748],[16.3968,48.1775],[16.3888,48.1828],[16.3820,48.1892],[16.3768,48.1961]]]}},
{"type":"Feature","properties":{"B":4},"geometry":{"type":"Polygon","coordinates":[[[16.3551,48.1986],[16.3563,48.1978],[16.3594,48.1960],[16.3633,48.1938],[16.3680,48.1928],[16.3728,48.1937],[16.3768,48.1961],[16.3820,48.1892],[16.3755,48.1848],[16.3672,48.1818],[16.3585,48.1822],[16.3508,48.1858],[16.3480,48.1912],[16.3495,48.1960],[16.3525,48.1982],[16.3551,48.1986]]]}},
{"type":"Feature","properties":{"B":5},"geometry":{"type":"Polygon","coordinates":[[[16.3480,48.1912],[16.3508,48.1858],[16.3585,48.1822],[16.3585,48.1772],[16.3538,48.1748],[16.3468,48.1742],[16.3398,48.1762],[16.3355,48.1812],[16.3352,48.1868],[16.3390,48.1908],[16.3438,48.1922],[16.3480,48.1912]]]}},
{"type":"Feature","properties":{"B":6},"geometry":{"type":"Polygon","coordinates":[[[16.3480,48.1912],[16.3438,48.1922],[16.3390,48.1908],[16.3352,48.1868],[16.3305,48.1888],[16.3292,48.1938],[16.3312,48.1982],[16.3362,48.2008],[16.3428,48.2012],[16.3492,48.1990],[16.3525,48.1982],[16.3495,48.1960],[16.3480,48.1912]]]}},
{"type":"Feature","properties":{"B":7},"geometry":{"type":"Polygon","coordinates":[[[16.3292,48.1938],[16.3305,48.1888],[16.3258,48.1872],[16.3208,48.1892],[16.3188,48.1942],[16.3202,48.1995],[16.3248,48.2028],[16.3315,48.2038],[16.3362,48.2008],[16.3312,48.1982],[16.3292,48.1938]]]}},
{"type":"Feature","properties":{"B":8},"geometry":{"type":"Polygon","coordinates":[[[16.3315,48.2038],[16.3248,48.2028],[16.3202,48.1995],[16.3192,48.2055],[16.3218,48.2115],[16.3275,48.2155],[16.3352,48.2165],[16.3432,48.2145],[16.3492,48.2098],[16.3492,48.2035],[16.3428,48.2012],[16.3362,48.2008],[16.3315,48.2038]]]}},
{"type":"Feature","properties":{"B":9},"geometry":{"type":"Polygon","coordinates":[[[16.3218,48.2115],[16.3192,48.2055],[16.3168,48.2062],[16.3128,48.2108],[16.3118,48.2168],[16.3148,48.2235],[16.3208,48.2295],[16.3292,48.2332],[16.3382,48.2338],[16.3462,48.2305],[16.3518,48.2248],[16.3532,48.2178],[16.3492,48.2098],[16.3432,48.2145],[16.3352,48.2165],[16.3275,48.2155],[16.3218,48.2115]]]}},
{"type":"Feature","properties":{"B":10},"geometry":{"type":"Polygon","coordinates":[[[16.3585,48.1822],[16.3672,48.1818],[16.3755,48.1848],[16.3820,48.1892],[16.3888,48.1828],[16.3968,48.1775],[16.4060,48.1748],[16.4155,48.1742],[16.4252,48.1770],[16.4318,48.1828],[16.4345,48.1898],[16.4378,48.1842],[16.4358,48.1728],[16.4272,48.1618],[16.4135,48.1508],[16.3975,48.1418],[16.3798,48.1362],[16.3618,48.1342],[16.3448,48.1388],[16.3358,48.1488],[16.3338,48.1598],[16.3358,48.1702],[16.3398,48.1762],[16.3468,48.1742],[16.3538,48.1748],[16.3585,48.1772],[16.3585,48.1822]]]}},
{"type":"Feature","properties":{"B":11},"geometry":{"type":"Polygon","coordinates":[[[16.4345,48.1898],[16.4315,48.1972],[16.4235,48.2042],[16.4148,48.2110],[16.4158,48.2190],[16.4230,48.2042],[16.4308,48.1978],[16.4428,48.1952],[16.4558,48.1912],[16.4678,48.1852],[16.4798,48.1752],[16.4872,48.1618],[16.4848,48.1488],[16.4722,48.1378],[16.4558,48.1318],[16.4378,48.1308],[16.4278,48.1378],[16.4198,48.1478],[16.4272,48.1618],[16.4358,48.1728],[16.4378,48.1842],[16.4345,48.1898]]]}},
{"type":"Feature","properties":{"B":12},"geometry":{"type":"Polygon","coordinates":[[[16.3125,48.1595],[16.3125,48.1742],[16.3188,48.1822],[16.3258,48.1872],[16.3305,48.1888],[16.3352,48.1868],[16.3355,48.1812],[16.3398,48.1762],[16.3358,48.1702],[16.3338,48.1598],[16.3268,48.1528],[16.3178,48.1532],[16.3125,48.1595]]]}},
{"type":"Feature","properties":{"B":13},"geometry":{"type":"Polygon","coordinates":[[[16.2578,48.1388],[16.2428,48.1568],[16.2478,48.1758],[16.2638,48.1918],[16.2848,48.2008],[16.3058,48.2008],[16.3128,48.1948],[16.3125,48.1742],[16.3125,48.1595],[16.3018,48.1508],[16.2868,48.1438],[16.2698,48.1408],[16.2578,48.1388]]]}},
{"type":"Feature","properties":{"B":14},"geometry":{"type":"Polygon","coordinates":[[[16.2848,48.2008],[16.2638,48.1918],[16.2608,48.2048],[16.2648,48.2188],[16.2758,48.2328],[16.2928,48.2418],[16.3098,48.2428],[16.3218,48.2358],[16.3258,48.2238],[16.3208,48.2148],[16.3128,48.2108],[16.3068,48.2038],[16.3058,48.2008],[16.2848,48.2008]]]}},
{"type":"Feature","properties":{"B":15},"geometry":{"type":"Polygon","coordinates":[[[16.3128,48.1948],[16.3058,48.2008],[16.3068,48.2038],[16.3128,48.2108],[16.3192,48.2055],[16.3188,48.1942],[16.3208,48.1892],[16.3188,48.1822],[16.3125,48.1742],[16.3128,48.1948]]]}},
{"type":"Feature","properties":{"B":16},"geometry":{"type":"Polygon","coordinates":[[[16.2928,48.2418],[16.2898,48.2558],[16.2958,48.2678],[16.3098,48.2738],[16.3248,48.2718],[16.3378,48.2638],[16.3428,48.2508],[16.3378,48.2388],[16.3258,48.2328],[16.3218,48.2358],[16.3098,48.2428],[16.2928,48.2418]]]}},
{"type":"Feature","properties":{"B":17},"geometry":{"type":"Polygon","coordinates":[[[16.2958,48.2678],[16.2938,48.2828],[16.3018,48.2948],[16.3168,48.3018],[16.3348,48.2998],[16.3498,48.2928],[16.3568,48.2808],[16.3528,48.2678],[16.3428,48.2598],[16.3378,48.2638],[16.3248,48.2718],[16.3098,48.2738],[16.2958,48.2678]]]}},
{"type":"Feature","properties":{"B":18},"geometry":{"type":"Polygon","coordinates":[[[16.3378,48.2638],[16.3428,48.2508],[16.3512,48.2448],[16.3558,48.2378],[16.3528,48.2298],[16.3458,48.2298],[16.3378,48.2328],[16.3258,48.2328],[16.3378,48.2388],[16.3428,48.2508],[16.3378,48.2638],[16.3428,48.2598],[16.3528,48.2678],[16.3568,48.2808],[16.3638,48.2808],[16.3728,48.2748],[16.3758,48.2648],[16.3718,48.2548],[16.3638,48.2468],[16.3558,48.2448],[16.3512,48.2448],[16.3428,48.2508],[16.3378,48.2638]]]}},
{"type":"Feature","properties":{"B":19},"geometry":{"type":"Polygon","coordinates":[[[16.3558,48.2378],[16.3512,48.2448],[16.3638,48.2468],[16.3718,48.2548],[16.3758,48.2648],[16.3728,48.2748],[16.3808,48.2838],[16.3958,48.2918],[16.4128,48.2948],[16.4278,48.2908],[16.4388,48.2818],[16.4408,48.2698],[16.4328,48.2588],[16.4188,48.2508],[16.4058,48.2478],[16.3948,48.2468],[16.3828,48.2428],[16.3748,48.2378],[16.3718,48.2308],[16.3688,48.2258],[16.3638,48.2238],[16.3578,48.2248],[16.3528,48.2298],[16.3558,48.2378]]]}},
{"type":"Feature","properties":{"B":20},"geometry":{"type":"Polygon","coordinates":[[[16.3688,48.2258],[16.3718,48.2308],[16.3748,48.2378],[16.3828,48.2428],[16.3948,48.2468],[16.4058,48.2478],[16.4128,48.2378],[16.4128,48.2265],[16.4068,48.2325],[16.3985,48.2358],[16.3900,48.2345],[16.3820,48.2305],[16.3768,48.2245],[16.3748,48.2178],[16.3748,48.2118],[16.3728,48.2198],[16.3698,48.2238],[16.3688,48.2258]]]}},
{"type":"Feature","properties":{"B":21},"geometry":{"type":"Polygon","coordinates":[[[16.3948,48.2468],[16.4058,48.2478],[16.4188,48.2508],[16.4328,48.2588],[16.4418,48.2648],[16.4598,48.2768],[16.4818,48.2898],[16.5018,48.2978],[16.4978,48.3198],[16.4718,48.3378],[16.4418,48.3478],[16.4118,48.3498],[16.3838,48.3428],[16.3658,48.3278],[16.3598,48.3088],[16.3638,48.2918],[16.3808,48.2838],[16.3728,48.2748],[16.3758,48.2648],[16.3718,48.2548],[16.3638,48.2468],[16.3512,48.2448],[16.3428,48.2598],[16.3528,48.2678],[16.3568,48.2808],[16.3638,48.2808],[16.3728,48.2748],[16.3808,48.2838],[16.3958,48.2918],[16.4128,48.2948],[16.4278,48.2908],[16.4388,48.2818],[16.4408,48.2698],[16.4328,48.2588],[16.4188,48.2508],[16.4058,48.2478],[16.3948,48.2468]]]}},
{"type":"Feature","properties":{"B":22},"geometry":{"type":"Polygon","coordinates":[[[16.4058,48.2478],[16.4128,48.2378],[16.4128,48.2265],[16.4158,48.2190],[16.4148,48.2110],[16.4158,48.2190],[16.4230,48.2042],[16.4308,48.1978],[16.4428,48.1952],[16.4558,48.1912],[16.4678,48.1852],[16.4798,48.1752],[16.4872,48.1618],[16.5098,48.1848],[16.5318,48.2098],[16.5438,48.2398],[16.5418,48.2698],[16.5278,48.2958],[16.5018,48.2978],[16.4818,48.2898],[16.4598,48.2768],[16.4418,48.2648],[16.4328,48.2588],[16.4188,48.2508],[16.4058,48.2478]]]}},
{"type":"Feature","properties":{"B":23},"geometry":{"type":"Polygon","coordinates":[[[16.2578,48.1388],[16.2698,48.1408],[16.2868,48.1438],[16.3018,48.1508],[16.3125,48.1595],[16.3178,48.1532],[16.3268,48.1528],[16.3338,48.1598],[16.3358,48.1488],[16.3448,48.1388],[16.3618,48.1342],[16.3798,48.1362],[16.3878,48.1198],[16.3718,48.1058],[16.3398,48.0938],[16.2998,48.0898],[16.2498,48.0948],[16.2178,48.1018],[16.2058,48.1148],[16.2198,48.1298],[16.2428,48.1568],[16.2578,48.1388]]]}}
]};

const PROXIES=[
  u=>`https://corsproxy.io/?url=${encodeURIComponent(u)}`,
  u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  u=>`https://thingproxy.freeboard.io/fetch/${u}`
];
const WFS='https://data.wien.gv.at/daten/geo?service=WFS&request=GetFeature&version=1.1.0&outputFormat=application/json&srsName=EPSG:4326';

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let map, marker, hlLayer, zoneLayer;
let selBez = null;
let curSheet = null;
let swipeY = 0;

// ‚îÄ‚îÄ Onboarding ‚îÄ‚îÄ
function mkGrid(id, cb) {
  const g = document.getElementById(id);
  g.innerHTML = '';
  BEZ.forEach(([nr, name]) => {
    const b = document.createElement('button');
    b.className = 'bez-btn';
    b.innerHTML = `<span class="bez-nr">${nr}</span>${name}`;
    b.addEventListener('click', () => cb(nr, b, g));
    g.appendChild(b);
  });
}

function initOB() {
  mkGrid('obGrid', (nr, btn, g) => {
    g.querySelectorAll('.bez-btn').forEach(b => b.classList.remove('sel'));
    btn.classList.add('sel');
    const ob = document.getElementById('obBtn');
    ob.classList.add('rdy');
    ob.dataset.bez = nr;
  });
  mkGrid('shBezGrid', (nr, btn, g) => {
    g.querySelectorAll('.bez-btn').forEach(b => b.classList.remove('sel'));
    btn.classList.add('sel');
    setBez(nr);
    setTimeout(closeSheet, 300);
  });

  document.getElementById('obBtn').addEventListener('click', () => {
    const bez = parseInt(document.getElementById('obBtn').dataset.bez);
    if (!bez) return;
    localStorage.setItem('pp_ob', '1');
    setBez(bez);
    document.getElementById('onboarding').classList.add('gone');
    toast('Gespeichert! GPS-Button tippen üìç', 'ok');
  });

  const ob = localStorage.getItem('pp_ob');
  const saved = parseInt(localStorage.getItem('pp_bez') || '0');
  if (ob && saved) {
    document.getElementById('onboarding').classList.add('gone');
    setBez(saved, false);
    const ps = localStorage.getItem('pp_pos');
    if (ps) {
      try {
        const {lat, lng} = JSON.parse(ps);
        placeMarker(lat, lng, null);
        map.setView([lat, lng], 15);
        checkPt(lat, lng);
      } catch(e) {}
    }
  }
}

// ‚îÄ‚îÄ Bezirk ‚îÄ‚îÄ
function setBez(nr, hl=true) {
  selBez = nr;
  localStorage.setItem('pp_bez', nr);
  const name = BEZ.find(b => b[0] === nr)?.[1] || '';
  document.getElementById('bezLabel').textContent = `${nr}. ${name}`;
  document.getElementById('bezirkBtn').classList.add('sel');
  document.getElementById('iBez').textContent = `${nr}. Bezirk`;
  document.querySelectorAll('#shBezGrid .bez-btn').forEach((b, i) => {
    b.classList.toggle('sel', BEZ[i][0] === nr);
  });
  if (hl) hlBez(nr);
}

function hlBez(nr) {
  if (hlLayer) { map.removeLayer(hlLayer); hlLayer = null; }
  if (zoneLayer) { map.removeLayer(zoneLayer); zoneLayer = null; }
  const feat = GEO.features.find(f => f.properties.B === nr);
  if (!feat) return;
  hlLayer = L.geoJSON(feat, {
    style: {color:'#E2001A', weight:2.5, fillColor:'#f0c844', fillOpacity:.18, opacity:.9}
  }).addTo(map);
  map.fitBounds(hlLayer.getBounds(), {padding:[40,40], animate:true});
  loadZones(nr, feat);
}

async function loadZones(nr, feat) {
  const b = L.geoJSON(feat).getBounds();
  const bbox = `${b.getWest()},${b.getSouth()},${b.getEast()},${b.getNorth()},EPSG:4326`;
  const url = `${WFS}&typeName=ogdwien:KURZPARKSTREIFENOGD&BBOX=${bbox}`;
  for (const p of PROXIES) {
    try {
      const r = await fetch(p(url));
      if (!r.ok) throw 0;
      const d = await r.json();
      if (!d.features) throw 0;
      if (zoneLayer) map.removeLayer(zoneLayer);
      zoneLayer = L.geoJSON(d, {
        style:{color:'#E2001A', weight:1.5, fillColor:'#E2001A', fillOpacity:.2, opacity:.8}
      }).addTo(map);
      break;
    } catch(e) {}
  }
}

// ‚îÄ‚îÄ Karte ‚îÄ‚îÄ
function initMap() {
  map = L.map('map', {center:[48.2082,16.3738], zoom:12, zoomControl:false});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    attribution:'¬© OpenStreetMap ¬© CARTO', subdomains:'abcd', maxZoom:19
  }).addTo(map);
  L.control.zoom({position:'topleft'}).addTo(map);
  map.on('click', e => {
    placeMarker(e.latlng.lat, e.latlng.lng, null);
    localStorage.setItem('pp_pos', JSON.stringify({lat:e.latlng.lat, lng:e.latlng.lng}));
    checkPt(e.latlng.lat, e.latlng.lng);
  });
}

function placeMarker(lat, lng, acc) {
  if (marker) map.removeLayer(marker);
  marker = L.circleMarker([lat, lng], {
    radius:10, color:'#E2001A', fillColor:'#E2001A', fillOpacity:.9, weight:3
  }).addTo(map);
  document.getElementById('iLat').textContent = lat.toFixed(6);
  document.getElementById('iLng').textContent = lng.toFixed(6);
  document.getElementById('iAcc').textContent = acc ? `¬±${Math.round(acc)}m` : 'Karten-Tap';
}

// ‚îÄ‚îÄ GPS ‚îÄ‚îÄ
function getGPS() {
  if (!selBez) { toast('Zuerst Bezirk w√§hlen!', 'inf'); openSheet('shBez'); return; }
  if (!navigator.geolocation) { showR('no','üö´','Kein GPS','Browser unterst√ºtzt keine Ortung'); return; }

  const fab = document.getElementById('gpsFab');
  fab.classList.add('spin'); fab.textContent = 'üì°';
  showR('chk','üì°','GPS‚Ä¶','Standort wird ermittelt‚Ä¶');

  navigator.geolocation.getCurrentPosition(
    pos => {
      fab.classList.remove('spin'); fab.textContent = 'üìç';
      const {latitude:lat, longitude:lng, accuracy:acc} = pos.coords;
      placeMarker(lat, lng, acc);
      localStorage.setItem('pp_pos', JSON.stringify({lat, lng}));
      map.setView([lat, lng], 16, {animate:true});
      checkPt(lat, lng);
    },
    err => {
      fab.classList.remove('spin'); fab.textContent = 'üìç';
      const msg = err.code===1
        ? 'GPS gesperrt ‚Üí Einst. ‚Üí Safari ‚Üí Ortung ‚Üí Erlauben'
        : err.code===3 ? 'GPS Timeout ‚Äì nochmal versuchen' : 'Position nicht ermittelbar';
      showR('no','üö´','GPS Fehler', msg);
      toast(err.code===1 ? 'GPS in Einstellungen erlauben!' : 'GPS Fehler', 'err');
    },
    {enableHighAccuracy:true, timeout:15000, maximumAge:0}
  );
}

// ‚îÄ‚îÄ API Check ‚îÄ‚îÄ
async function checkPt(lat, lng) {
  if (!selBez) { showR('','‚ö†Ô∏è','Bezirk fehlt','Oben "Bezirk w√§hlen" tippen'); return; }
  showR('chk','‚è≥','Pr√ºfe‚Ä¶','API Anfrage l√§uft‚Ä¶');
  document.getElementById('iApi').textContent = '‚Ä¶';

  const d = 0.003;
  const bbox = `${lng-d},${lat-d},${lng+d},${lat+d},EPSG:4326`;
  const url = `${WFS}&typeName=ogdwien:PARKENBERECHTOGD&BBOX=${bbox}`;

  let data = null;
  for (let i=0; i<PROXIES.length; i++) {
    try {
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), 13000);
      const res = await fetch(PROXIES[i](url), {signal:ctrl.signal});
      clearTimeout(t);
      if (!res.ok) throw 0;
      const p = await res.json();
      if (!p.features) throw 0;
      data = p;
      document.getElementById('iApi').textContent = `OK (P${i+1})`;
      break;
    } catch(e) {}
  }

  document.getElementById('iTime').textContent = new Date().toLocaleTimeString('de-AT');

  if (!data) {
    showR('','üö´','Offline','API nicht erreichbar ‚Äì Karte antippen');
    document.getElementById('iApi').textContent = 'fehlgeschlagen';
    toast('API offline', 'err');
    return;
  }

  const inZone = data.features.filter(f => ptInFeat([lng,lat], f));
  if (!inZone.length) {
    showR('ok','‚úÖ','Freies Parken','Keine Kurzparkzone ‚Äì unbegrenzt parken');
    return;
  }
  const match = inZone.filter(f =>
    Object.keys(f.properties).some(k => /bez/i.test(k) && parseInt(f.properties[k])===selBez)
  );
  if (match.length) {
    showR('ok','‚úÖ','Pickerl g√ºltig!',`${selBez}. Bezirk ‚Äì Pickerlzone gilt hier`);
  } else {
    const other = (() => {
      for (const f of inZone)
        for (const k of Object.keys(f.properties))
          if (/bez/i.test(k) && f.properties[k]) try { return parseInt(f.properties[k]); } catch(e){}
      return null;
    })();
    showR('no','‚ùå','Andere Zone', other ? `Hier gilt Zone ${other}. Bezirk` : 'Andere Pickerlzone');
  }
}

function ptInRing(pt, ring) {
  const [x,y]=pt; let ins=false, j=ring.length-1;
  for (let i=0;i<ring.length;j=i++) {
    const [xi,yi]=ring[i],[xj,yj]=ring[j];
    if (((yi>y)!=(yj>y))&&(x<(xj-xi)*(y-yi)/(yj-yi)+xi)) ins=!ins;
  }
  return ins;
}
function ptInFeat(pt, f) {
  const g=f.geometry; if(!g) return false;
  if (g.type==='Polygon') return ptInRing(pt, g.coordinates[0]);
  if (g.type==='MultiPolygon') return g.coordinates.some(p=>ptInRing(pt,p[0]));
  return false;
}

// ‚îÄ‚îÄ UI ‚îÄ‚îÄ
function showR(cls, icon, title, sub) {
  const c = document.getElementById('resultCard');
  c.className = 'vis' + (cls?' '+cls:'');
  document.getElementById('rIcon').textContent = icon;
  document.getElementById('rTitle').textContent = title;
  document.getElementById('rSub').textContent = sub;
}
function hideResult() { document.getElementById('resultCard').classList.remove('vis'); }

function openSheet(id) {
  if (curSheet) closeSheet();
  curSheet = id;
  document.getElementById(id).classList.add('vis');
  document.getElementById('overlay').classList.add('vis');
  const s = document.getElementById(id);
  s.ontouchstart = e => { swipeY = e.touches[0].clientY; };
  s.ontouchend = e => { if (e.changedTouches[0].clientY - swipeY > 80) closeSheet(); };
}
function closeSheet() {
  if (!curSheet) return;
  document.getElementById(curSheet).classList.remove('vis');
  document.getElementById('overlay').classList.remove('vis');
  curSheet = null;
}

let toastT;
function toast(msg, type='inf') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = `toast ${type} vis`;
  clearTimeout(toastT);
  toastT = setTimeout(()=>t.classList.remove('vis'), 3500);
}

function clearCache() {
  localStorage.removeItem('pp_pos');
  toast('Cache gel√∂scht','inf');
  closeSheet();
}

// ‚îÄ‚îÄ PWA ‚îÄ‚îÄ
let dP=null;
if('serviceWorker'in navigator) navigator.serviceWorker.register('/sw.js').catch(()=>{});
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();dP=e;});
document.getElementById('installBanner') && (document.getElementById('installBanner').style.display='none');

window.addEventListener('online', ()=>document.getElementById('offline').classList.remove('vis'));
window.addEventListener('offline', ()=>document.getElementById('offline').classList.add('vis'));
if(!navigator.onLine) document.getElementById('offline').classList.add('vis');

// ‚îÄ‚îÄ Start ‚îÄ‚îÄ
initMap();
initOB();
</script>
</body>
</html>
